dir("D:/ST-UK2022/DATA/EMEPUK/processed")
librarian::shelf(terra, scattermore, ggplot2, data.table)
year <- 2020
pollfiles <- c("V:/VolumeQ/AGteam/ST-UK-22/RESULTS/netcdf_maps/no2_2020.nc")
emepfiles <- c("D:/ST-UK2022/DATA/EMEPUK/processed/SURF_ug_NO2__2020.nc")
tempfiles <- c("V:/VolumeQ/AGteam/MetData/PROCESSED/tempmean_v1300/tasmean_hadukgrid_2020.nc")
era5files <- c("D:/ST-UK2022/DATA/ERA_5_Land/processed/Temperature/t2m__2020.nc")
r_poll <- rast(pollfiles)
r_emep <-  rast(emepfiles)
r_temp <- rast(tempfiles)
r_e5l <-  rast(era5files)
time(r_pm) <- 1:366
time(r_poll) <- 1:366
time(r_temp) <- 1:366
time(r_e5l) <- 1:366
time(r_emep) <- 1:366
dfl_poll <-
melt(
setDT(as.data.frame(r_poll, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="pm"
)[,variable:=as.numeric(as.character(variable))]
dfl_temp <-
melt(
setDT(as.data.frame(r_temp, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="temp"
)[,variable:=as.numeric(as.character(variable))]
dfl_e5l <-
melt(
setDT(as.data.frame(r_e5l, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="e5l"
)[,variable:=as.numeric(as.character(variable))]
dfl_emep <-
melt(
setDT(as.data.frame(r_emep, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="emep"
)[,variable:=as.numeric(as.character(variable))]
names(dfl_poll) <- c("x","y","variable","poll")
dt_merged <- Reduce(
function(x, y) merge(x, y, by = c("x", "y", "variable"), all=FALSE),
list(dfl_poll, dfl_temp, dfl_e5l, dfl_emep)
)
dt_merged[,btemp:=round(temp)][,be5l:=round(e5l)]
# summary stats - we want to make one dataframe summary for poll and one for emep, one by btemp and one by be5l, so four dataframes in total
summary_poll_btemp <- dt_merged[, .(
mean_poll = median(poll, na.rm = TRUE),
p10_poll = quantile(poll, probs = 0.10, na.rm = TRUE),
p90_poll = quantile(poll, probs = 0.90, na.rm = TRUE)
), by = .(btemp)]
summary_poll_be5l <- dt_merged[, .(
mean_poll = median(poll, na.rm = TRUE),
p10_poll = quantile(poll, probs = 0.10, na.rm = TRUE),
p90_poll = quantile(poll, probs = 0.90, na.rm = TRUE)
), by = .(be5l)]
summary_emep_btemp <- dt_merged[, .(
mean_emep = median(emep, na.rm = TRUE),
p10_emep = quantile(emep, probs = 0.10, na.rm = TRUE),
p90_emep = quantile(emep, probs = 0.90, na.rm = TRUE)
), by = .(btemp)]
summary_emep_be5l <- dt_merged[, .(
mean_emep = median(emep, na.rm = TRUE),
p10_emep = quantile(emep, probs = 0.10, na.rm = TRUE),
p90_emep = quantile(emep, probs = 0.90, na.rm = TRUE)
), by = .(be5l)]
# plot
p1 <- ggplot(summary_poll_btemp, aes(x = btemp, y = mean_poll)) +
geom_ribbon(aes(ymin = p10_poll, ymax = p90_poll), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="SDE NO2 ~ SDE Temp.",
x="Temp. C SDE",
y="NO2 SDE") +
theme_minimal()
p2 <- ggplot(summary_poll_be5l, aes(x = be5l, y = mean_poll)) +
geom_ribbon(aes(ymin = p10_poll, ymax = p90_poll), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="SDE NO2 ~ ERA5Land Temp.",
x="Temp. K ERA5Land",
y="NO2 SDE") +
theme_minimal()
p3 <- ggplot(summary_emep_btemp, aes(x = btemp, y = mean_emep)) +
geom_ribbon(aes(ymin = p10_emep, ymax = p90_emep), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="Dispersion model NO2 ~ SDE Temp.",
x="Temp. C SDE",
y="NO2 EMEP") +
theme_minimal()
p4 <- ggplot(summary_emep_be5l, aes(x = be5l, y = mean_emep)) +
geom_ribbon(aes(ymin = p10_emep, ymax = p90_emep), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="Dispersion model NO2 ~ ERA5Land Temp.",
x="Temp. K ERA5Land",
y="NO2 EMEP") +
theme_minimal()
library(patchwork)
((p1+p2)/(p3+p4))
librarian::shelf(terra, scattermore, ggplot2, data.table)
year <- 2019
pollfiles <- c(paste0("V:/VolumeQ/AGteam/ST-UK-22/RESULTS/netcdf_maps/no2_",year,".nc"))
emepfiles <- c(paste0("D:/ST-UK2022/DATA/EMEPUK/processed/SURF_ug_NO2__",year,".nc"))
tempfiles <- c(paste0("V:/VolumeQ/AGteam/MetData/PROCESSED/tempmean_v1300/tasmean_hadukgrid_",year,".nc"))
era5files <- c(paste0("D:/ST-UK2022/DATA/ERA_5_Land/processed/Temperature/t2m__",year,".nc"))
r_poll <- rast(pollfiles)
r_emep <-  rast(emepfiles)
r_temp <- rast(tempfiles)
r_e5l <-  rast(era5files)
time(r_poll) <- 1:366
librarian::shelf(terra, scattermore, ggplot2, data.table)
year <- 2019
pollfiles <- c(paste0("V:/VolumeQ/AGteam/ST-UK-22/RESULTS/netcdf_maps/no2_",year,".nc"))
emepfiles <- c(paste0("D:/ST-UK2022/DATA/EMEPUK/processed/SURF_ug_NO2__",year,".nc"))
tempfiles <- c(paste0("V:/VolumeQ/AGteam/MetData/PROCESSED/tempmean_v1300/tasmean_hadukgrid_",year,".nc"))
era5files <- c(paste0("D:/ST-UK2022/DATA/ERA_5_Land/processed/Temperature/t2m__",year,".nc"))
r_poll <- rast(pollfiles)
r_emep <-  rast(emepfiles)
r_temp <- rast(tempfiles)
r_e5l <-  rast(era5files)
time(r_poll) <- 1:365
time(r_temp) <- 1:365
time(r_e5l) <- 1:365
time(r_emep) <- 1:365
# df_pm <- as.data.frame(r_pm, cells=FALSE, xy=TRUE, time=TRUE)
# df_temp <- as.data.frame(r_temp, cells=FALSE, xy=TRUE, time=TRUE)
# df_e5l <- as.data.frame(r_e5l, cells=FALSE, xy=TRUE, time=TRUE)
# df_emep <- as.data.frame(r_emep, cells=FALSE, xy=TRUE, time=TRUE)
#
# dfl_pm <- melt(setDT(df_pm), id.vars=c("x","y"), value.name="pm")
# dfl_temp <- melt(setDT(df_temp), id.vars=c("x","y"), value.name="temp")
# dfl_e5l <- melt(setDT(df_e5l), id.vars=c("x","y"), value.name="e5l")
# dfl_emep <- melt(setDT(df_emep), id.vars=c("x","y"), value.name="emep")
#
# dfl_pm[,variable:=as.numeric(as.character(variable))]
# dfl_temp[,variable:=as.numeric(as.character(variable))]
# dfl_emep[,variable:=as.numeric(as.character(variable))]
# dfl_e5l[,variable:=as.numeric(as.character(variable))]
# #
dfl_poll <-
melt(
setDT(as.data.frame(r_poll, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="poll"
)[,variable:=as.numeric(as.character(variable))]
dfl_temp <-
melt(
setDT(as.data.frame(r_temp, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="temp"
)[,variable:=as.numeric(as.character(variable))]
dfl_e5l <-
melt(
setDT(as.data.frame(r_e5l, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="e5l"
)[,variable:=as.numeric(as.character(variable))]
dfl_emep <-
melt(
setDT(as.data.frame(r_emep, cells=FALSE, xy=TRUE, time=TRUE)),
id.vars=c("x","y"), value.name="emep"
)[,variable:=as.numeric(as.character(variable))]
# inner join the above four tables
dt_merged <- Reduce(
function(x, y) merge(x, y, by = c("x", "y", "variable"), all=FALSE),
list(dfl_poll, dfl_temp, dfl_e5l, dfl_emep)
)
dt_merged[,btemp:=round(temp)][,be5l:=round(e5l)]
# summary stats - we want to make one dataframe summary for poll and one for emep, one by btemp and one by be5l, so four dataframes in total
summary_poll_btemp <- dt_merged[, .(
mean_poll = median(poll, na.rm = TRUE),
p10_poll = quantile(poll, probs = 0.10, na.rm = TRUE),
p90_poll = quantile(poll, probs = 0.90, na.rm = TRUE)
), by = .(btemp)]
summary_poll_be5l <- dt_merged[, .(
mean_poll = median(poll, na.rm = TRUE),
p10_poll = quantile(poll, probs = 0.10, na.rm = TRUE),
p90_poll = quantile(poll, probs = 0.90, na.rm = TRUE)
), by = .(be5l)]
summary_emep_btemp <- dt_merged[, .(
mean_emep = median(emep, na.rm = TRUE),
p10_emep = quantile(emep, probs = 0.10, na.rm = TRUE),
p90_emep = quantile(emep, probs = 0.90, na.rm = TRUE)
), by = .(btemp)]
summary_emep_be5l <- dt_merged[, .(
mean_emep = median(emep, na.rm = TRUE),
p10_emep = quantile(emep, probs = 0.10, na.rm = TRUE),
p90_emep = quantile(emep, probs = 0.90, na.rm = TRUE)
), by = .(be5l)]
# plot
p1 <- ggplot(summary_poll_btemp, aes(x = btemp, y = mean_poll)) +
geom_ribbon(aes(ymin = p10_poll, ymax = p90_poll), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="SDE NO2 ~ SDE Temp.",
x="Temp. C SDE",
y="NO2 SDE") +
theme_minimal()
p2 <- ggplot(summary_poll_be5l, aes(x = be5l, y = mean_poll)) +
geom_ribbon(aes(ymin = p10_poll, ymax = p90_poll), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="SDE NO2 ~ ERA5Land Temp.",
x="Temp. K ERA5Land",
y="NO2 SDE") +
theme_minimal()
p3 <- ggplot(summary_emep_btemp, aes(x = btemp, y = mean_emep)) +
geom_ribbon(aes(ymin = p10_emep, ymax = p90_emep), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="Dispersion model NO2 ~ SDE Temp.",
x="Temp. C SDE",
y="NO2 EMEP") +
theme_minimal()
p4 <- ggplot(summary_emep_be5l, aes(x = be5l, y = mean_emep)) +
geom_ribbon(aes(ymin = p10_emep, ymax = p90_emep), alpha = 0.2, fill = "darkgreen") +
geom_line(color = "darkgreen", linewidth = 1) +
labs(
title="Dispersion model NO2 ~ ERA5Land Temp.",
x="Temp. K ERA5Land",
y="NO2 EMEP") +
theme_minimal()
library(patchwork)
((p1+p2)/(p3+p4))
setwd("C:/Users/lshad21/OneDrive - London School of Hygiene and Tropical Medicine/z_RDrive_hmm/pages_and_apps/ehm-lab.github.io")
source("C:/Users/lshad21/OneDrive - London School of Hygiene and Tropical Medicine/z_RDrive_hmm/pages_and_apps/ehm-lab.github.io/build_data_ehm_site.R", echo = TRUE)
View(ehm_pkgdf)
